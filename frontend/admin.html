<!DOCTYPE html>
<html>
<head>
  <title>Admin Dashboard - Quiz App</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 40px;
      background: #f9f9f9;
    }
    h2 {
      color: #333;
    }
    select, button {
      font-size: 16px;
      padding: 10px;
      margin: 10px 5px;
    }
    .button-group {
      margin-top: 20px;
    }
  </style>
</head>
<body>

<script>
  if (sessionStorage.getItem("role") !== "admin") {
    alert("Access denied. Login as admin.");
    window.location.href = "index.html";
  }
</script>

<h2>🛠 Admin Dashboard</h2>

<label for="testSelect">Select a Test:</label>
<select id="testSelect"><option>Loading...</option></select>

<div class="button-group">
  <button onclick="goTo('view-responses.html')">👁 View Responses</button>
  <button onclick="goTo('scores.html')">📊 View Scores</button>
  <button onclick="goTo('form.html')">📝 Create/Edit Test</button>
  <button onclick="downloadJSON()">📥 Download Data</button>
  <button onclick="logout()">🚪 Logout</button>
</div>

<script>
  const BASE_URL = "https://quiz-app-4087.onrender.com";

  function goTo(page) {
    const testId = document.getElementById("testSelect").value;
    if (!testId) return alert("Please select a test.");
    sessionStorage.setItem("selectedTest", testId);
    window.location.href = page;
  }

  function logout() {
    sessionStorage.clear();
    window.location.href = "index.html";
  }

  async function downloadJSON() {
    const testId = document.getElementById("testSelect").value;
    if (!testId) return alert("Please select a test.");

    try {
      const res = await fetch(`${BASE_URL}/api/quiz/test/${testId}/responses`);
      const data = await res.json();
      const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
      const link = document.createElement("a");
      link.href = URL.createObjectURL(blob);
      link.download = `${testId}-responses.json`;
      link.click();
    } catch (err) {
      alert("❌ Failed to download data.");
      console.error(err);
    }
  }

  // Load tests
  window.onload = () => {
    fetch(`${BASE_URL}/api/quiz/tests`)
      .then(res => res.json())
      .then(tests => {
        const select = document.getElementById("testSelect");
        select.innerHTML = '<option value="">-- Select Test --</option>';
        tests.forEach(t => {
          const opt = document.createElement("option");
          opt.value = t;
          opt.textContent = t;
          select.appendChild(opt);
        });

        const previouslySelected = sessionStorage.getItem("selectedTest");
        if (previouslySelected) select.value = previouslySelected;
      })
      .catch(err => {
        console.error(err);
        alert("❌ Failed to load test list.");
      });
  };
</script>

</body>
</html>
