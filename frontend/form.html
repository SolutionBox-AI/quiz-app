<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>üìù Create / Edit Quiz</title>
  <style>
    body { font-family: Arial; margin: 40px; background: #f9f9f9; }
    h2 { margin-bottom: 20px; }
    input, textarea, select, button {
      font-size: 16px; padding: 8px; margin: 6px 0;
    }
    .question-block {
      background: #fff; border: 1px solid #ddd; padding: 16px; margin-bottom: 12px;
      position: relative; border-radius: 6px;
    }
    .delete-btn {
      position: absolute; top: 8px; right: 8px; background: #e74c3c;
      color: #fff; border: none; padding: 4px 8px; cursor: pointer;
    }
    .small { max-width: 200px; }
  </style>
  <script>
    const BASE = "https://quiz-app-4087.onrender.com/api/quiz";
    let currentTestId = "";

    async function loadTest() {
      currentTestId = document.getElementById("testSelect").value;
      if (!currentTestId) return clearForm();

      const res = await fetch(`${BASE}/test/${currentTestId}/questions`);
      const questions = await res.json();

      document.getElementById("title").textContent = `Edit Test: ${currentTestId}`;
      document.getElementById("testIdInput").value = currentTestId;
      renderQuestions(questions);
    }

    function clearForm() {
      currentTestId = "";
      document.getElementById("title").textContent = "Create New Test";
      document.getElementById("testIdInput").value = "";
      renderQuestions([]);
    }

    function renderQuestions(questions) {
      const container = document.getElementById("questionsContainer");
      container.innerHTML = "";
      questions.forEach(q => addQuestionBlock(q));
    }

    function addQuestionBlock(q = {}) {
      const container = document.getElementById("questionsContainer");
      const div = document.createElement("div");
      div.className = "question-block";

      div.innerHTML = `
        <button class="delete-btn" type="button" onclick="div.remove()">X</button>
        <textarea class="questionText" rows="2" placeholder="Question">${q.question || ""}</textarea><br>
        <label>A: <input type="text" class="optionA small" value="${q.options ? q.options[0] : ''}" /></label><br>
        <label>B: <input type="text" class="optionB small" value="${q.options ? q.options[1] : ''}" /></label><br>
        <label>C: <input type="text" class="optionC small" value="${q.options ? q.options[2] : ''}" /></label><br>
        <label>D: <input type="text" class="optionD small" value="${q.options ? q.options[3] : ''}" /></label><br>
        <label>Correct (A/B/C/D): <input type="text" maxlength="1" class="correctAnswer small" value="${q.options ? q.options[[q.options[0],q.options[1],q.options[2],q.options[3]].indexOf(q.correctAnswer)] : ''}" /></label>
      `;

      container.appendChild(div);
    }

    function addNewQuestion() {
      addQuestionBlock();
    }

    async function saveTest() {
      const testId = document.getElementById("testIdInput").value.trim();
      if (!testId) return alert("Enter Test ID or Name.");

      const texts = document.querySelectorAll(".questionText");
      const as = document.querySelectorAll(".optionA");
      const bs = document.querySelectorAll(".optionB");
      const cs = document.querySelectorAll(".optionC");
      const ds = document.querySelectorAll(".optionD");
      const corr = document.querySelectorAll(".correctAnswer");

      if (texts.length === 0) return alert("Add at least one question.");

      const arr = [];
      for (let i = 0; i < texts.length; i++) {
        const ops = [as[i].value.trim(), bs[i].value.trim(), cs[i].value.trim(), ds[i].value.trim()];
        const letter = corr[i].value.trim().toUpperCase();
        const idx = { A: 0, B: 1, C: 2, D: 3 }[letter];
        if (idx === undefined || !ops[idx]) return alert(`Invalid correct answer at Q${i + 1}`);
        arr.push({ question: texts[i].value.trim(), options: ops, correctAnswer: ops[idx] });
      }

      try {
        const res = await fetch(`${BASE}/test/${testId}/save`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(arr)
        });
        const data = await res.json();
        if (res.ok) {
          alert("‚úÖ Test saved!");
          init();
        } else {
          alert("‚ùå Save failed: " + (data.error || "Unknown"));
        }
      } catch (err) {
        console.error(err);
        alert("‚ö†Ô∏è Error saving test.");
      }
    }

    function init() {
      // load test dropdown
      fetch(`${BASE}/tests`)
        .then(r=>r.json())
        .then(tests => {
          const sel = document.getElementById("testSelect");
          sel.innerHTML = '<option value="">-- Select or Leave Empty --</option>';
          tests.forEach(t => sel.appendChild(new Option(t, t)));
        })
        .catch(()=>alert("Cannot load tests."));
      clearForm();
    }

    window.onload = () => {
      if (sessionStorage.getItem("role") !== "admin") {
        alert("Access denied.");
        location.href = "index.html";
      }
      init();
    };
  </script>
</head>
<body>
  <h2 id="title">Create New Test</h2>

  <label>Select Existing Test:</label>
  <select id="testSelect" onchange="loadTest()">
    <option>Loading...</option>
  </select>
  <br><br>

  <label>Test ID / Name:</label>
  <input type="text" id="testIdInput" placeholder="e.g., math-quiz-1"/><br><br>

  <div id="questionsContainer"></div>

  <button onclick="addNewQuestion()">‚ûï Add Question</button>
  <button onclick="saveTest()">üíæ Save Test</button>
  <button onclick="window.location.href='admin.html'">üîô Back to Admin</button>
</body>
</html>
