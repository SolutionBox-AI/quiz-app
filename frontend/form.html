<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <title>Create / Edit Test</title>
  <style>
    body { font-family: Arial, sans-serif; background: #f8f9fa; padding: 30px; }
    h1, label { color: #333; }
    select, input, textarea, button {
      display: block; width: 100%;
      margin: 10px 0; font-size: 16px;
      padding: 8px;
    }
    .question-block {
      background: #fff; padding: 15px;
      margin: 20px 0; border: 1px solid #ccc;
      border-radius: 6px;
    }
    .footer-buttons { margin-top: 20px; }
  </style>
</head>
<body>
  <script>
    if (sessionStorage.getItem("role") !== "admin") {
      alert("Access denied."); window.location.href = "index.html";
    }
  </script>

  <h1>üìù Create / Edit Test</h1>

  <label>Choose Action:</label>
  <select id="actionSelect" onchange="handleAction()">
    <option value="">-- Select --</option>
    <option value="create">‚ûï Create New Test</option>
    <option value="edit">‚úèÔ∏è Edit Existing Test</option>
  </select>

  <div id="newTestDiv" style="display:none;">
    <label>New Test Name:</label>
    <input id="newTestId" placeholder="e.g. demo-test-1" />
  </div>

  <div id="editTestDiv" style="display:none;">
    <label>Select Test to Edit:</label>
    <select id="editTestSelect"><option>Loading tests...</option></select>
  </div>

  <div class="footer-buttons">
    <button onclick="loadQuestions()">üì• Load Test</button>
    <button onclick="addQuestion()">‚ûï Add Question</button>
  </div>

  <div id="questionsContainer"></div>

  <div class="footer-buttons">
    <button onclick="saveTest()">üíæ Save Test</button>
    <button onclick="location.href='admin.html'">üè† Back to Admin</button>
  </div>

  <script>
    const BASE = "https://quiz-app-4087.onrender.com/api/quiz";
    let currentTestId = "";
    let qCount = 0;

    function handleAction() {
      const shell = document.getElementById("actionSelect").value;
      document.getElementById("newTestDiv").style.display = shell === "create" ? "block":"none";
      document.getElementById("editTestDiv").style.display = shell === "edit" ? "block":"none";
      if (shell === "edit") loadTestList();
    }

    function loadTestList() {
      fetch(`${BASE}/tests`).then(r => r.json()).then(tests => {
        const sel = document.getElementById("editTestSelect");
        sel.innerHTML = '<option>-- Select --</option>';
        tests.forEach(t=> sel.appendChild(new Option(t,t)));
      });
    }

    function loadQuestions() {
      const action = document.getElementById("actionSelect").value;

      if (action === "create") {
        currentTestId = document.getElementById("newTestId").value.trim();
        if (!currentTestId) return alert("Enter test name.");
        document.getElementById("questionsContainer").innerHTML = "";
        qCount = 0;

      } else if (action === "edit") {
        currentTestId = document.getElementById("editTestSelect").value;
        if (!currentTestId) return alert("Select test.");

        fetch(`${BASE}/test/${currentTestId}/questions`)
          .then(r => r.json())
          .then(ques => {
            const cont = document.getElementById("questionsContainer");
            cont.innerHTML = "";
            qCount = 0;
            ques.forEach(q=> addQuestion(q.question,q.options,q.correctAnswer));
          })
          .catch(()=>alert("Failed to load questions"));
      }
    }

    function addQuestion(q="",ops=["","","",""],corr="") {
      const cont = document.getElementById("questionsContainer");
      qCount++;
      const div = document.createElement("div");
      div.className="question-block";
      div.innerHTML = `
        <h3>Q${qCount}</h3>
        <textarea class="questionText">${q}</textarea><br>
        A: <input class="optionA" value="${ops[0]}"><br>
        B: <input class="optionB" value="${ops[1]}"><br>
        C: <input class="optionC" value="${ops[2]}"><br>
        D: <input class="optionD" value="${ops[3]}"><br>
        Correct (A/B/C/D): <input class="correctAnswer" value="${["A","B","C","D"][ops.indexOf(corr)]||""}"><br>
        <button onclick="this.parentNode.remove()">üóë Delete question</button>
      `;
      cont.appendChild(div);
    }

    function saveTest() {
      if (!currentTestId) return alert("No test loaded.");
      const texts = document.querySelectorAll(".questionText");
      const as = document.querySelectorAll(".optionA");
      const bs = document.querySelectorAll(".optionB");
      const cs = document.querySelectorAll(".optionC");
      const ds = document.querySelectorAll(".optionD");
      const corr = document.querySelectorAll(".correctAnswer");

      const arr = [];
      for (let i=0;i<texts.length;i++){
        const ops=[as[i].value,bs[i].value,cs[i].value,ds[i].value];
        const c=corr[i].value.toUpperCase();
        const idx={"A":0,"B":1,"C":2,"D":3}[c];
        if (idx===undefined) return alert(`Invalid correct letter at Q${i+1}`);
        arr.push({question:texts[i].value, options:ops, correctAnswer:ops[idx]});
      }
      fetch(`${BASE}/test/${currentTestId}/save`, {
        method:"POST", headers:{"Content-Type":"application/json"}, body: JSON.stringify(arr)
      })
      .then(r=>r.json())
      .then(d=> r.ok ? alert("Saved successfully!") : alert("Save failed: "+d.error))
      .catch(()=>alert("Server error while saving."));
    }
  </script>
</body>
</html>
