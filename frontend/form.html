<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Create/Edit Test</title>
  <style>
    body { font-family: Arial; margin: 40px; }
    input, select, button { padding: 8px; margin: 5px; font-size: 16px; }
    textarea { width: 400px; height: 60px; margin: 5px; display: block; }
    .question-block { border: 1px solid #ccc; padding: 10px; margin-bottom: 15px; }
  </style>
</head>
<body>

<script>
  if (sessionStorage.getItem("role") !== "admin") {
    alert("Access denied.");
    window.location.href = "index.html";
  }
</script>

<h2>📝 Create / Edit Quiz</h2>

<label for="testIdInput">Test Name:</label>
<input id="testIdInput" placeholder="Enter new or existing test ID" />
<button onclick="loadTest()">📂 Load</button>

<div id="controls" style="display:none;">
  <button onclick="addQuestion()">➕ Add Question</button>
  <button onclick="saveTest()">💾 Save Test</button>
</div>

<div id="questionContainer"></div>

<button onclick="logout()">🔙 Logout</button>

<script>
  const BASE = "https://quiz-app-4087.onrender.com/api/quiz";
  let currentTestId = "";

  function loadTest() {
    currentTestId = document.getElementById("testIdInput").value.trim();
    if (!currentTestId) return alert("Enter a test name first.");

    document.getElementById("controls").style.display = "block";

    fetch(`${BASE}/test/${currentTestId}/questions`)
      .then(res => res.json())
      .then(questions => {
        const container = document.getElementById("questionContainer");
        container.innerHTML = "";
        questions.forEach(q => renderQuestion(q));
      })
      .catch(() => alert("New test. Start adding questions."));
  }

  function renderQuestion(q = { question: "", options: ["", "", "", ""], correctAnswer: "" }) {
    const idx = ["A", "B", "C", "D"];
    const div = document.createElement("div");
    div.className = "question-block";

    div.innerHTML = `
      <textarea class="questionText" placeholder="Question">${q.question}</textarea>
      ${q.options.map((opt, i) => `
        <input class="option${idx[i]}" placeholder="Option ${idx[i]}" value="${opt}" />
      `).join("")}
      <input class="correctAnswer" placeholder="Correct (A/B/C/D)" value="${idx[q.options.indexOf(q.correctAnswer)] || ""}" />
      <button onclick="this.parentElement.remove()">❌ Delete</button>
    `;
    document.getElementById("questionContainer").appendChild(div);
  }

  function addQuestion() {
    renderQuestion();
  }

  function saveTest() {
    if (!currentTestId) return alert("No test loaded.");
    const adminEmail = sessionStorage.getItem("email");
    const blocks = document.querySelectorAll(".question-block");

    const questions = Array.from(blocks).map(block => {
      const qText = block.querySelector(".questionText").value;
      const ops = ["A", "B", "C", "D"].map(l => block.querySelector(".option" + l).value);
      const correctLetter = block.querySelector(".correctAnswer").value.toUpperCase();
      const idx = { A: 0, B: 1, C: 2, D: 3 }[correctLetter];
      if (idx === undefined) throw new Error(`Invalid correct answer at "${qText}"`);
      return { testId: currentTestId, question: qText, options: ops, correctAnswer: ops[idx], createdBy: adminEmail };
    });

    fetch(`${BASE}/test/${currentTestId}/save`, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(questions)
    })
    .then(res => res.json())
    .then(data => alert("✅ " + data.message))
    .catch(err => {
      console.error(err);
      alert("❌ Failed to save test.");
    });
  }

  function logout() {
    sessionStorage.clear();
    window.location.href = "index.html";
  }
</script>

</body>
</html>

