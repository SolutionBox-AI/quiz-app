<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <title>Take Quiz</title>
  <style>
    body { font-family: Arial, sans-serif; padding: 30px; background: #f4f6f9; }
    input, select, button { padding: 10px; font-size: 16px; margin: 10px 0; width: 100%; max-width: 400px; }
    .question { margin-top: 20px; padding: 15px; background: #fff; border: 1px solid #ccc; border-radius: 6px; }
  </style>
</head>
<body>

  <h2>üß† Start Your Quiz</h2>

  <label>Enter Your Name:</label>
  <input type="text" id="name" placeholder="Your Name"/>

  <label>Enter Your User Code:</label>
  <input type="text" id="userCode" placeholder="e.g. Roll No / ID"/>

  <label>Select Test:</label>
  <select id="testSelect"><option>Loading...</option></select>

  <div id="quizContainer" style="display: none;"></div>

  <button id="submitBtn" onclick="submitQuiz()" style="display: none;">üöÄ Submit Quiz</button>

  <script>
    const BASE = "https://quiz-app-4087.onrender.com/api/quiz";

    async function loadTests() {
      const res = await fetch(`${BASE}/tests`);
      const tests = await res.json();
      const sel = document.getElementById("testSelect");
      sel.innerHTML = '<option value="">-- Select Test --</option>';
      tests.forEach(t => sel.appendChild(new Option(t, t)));
    }

    async function loadQuestions(testId) {
      const res = await fetch(`${BASE}/test/${testId}/questions`);
      const questions = await res.json();

      const cont = document.getElementById("quizContainer");
      cont.innerHTML = "";
      questions.forEach((q, i) => {
        const div = document.createElement("div");
        div.className = "question";
        div.innerHTML = `<strong>Q${i + 1}:</strong> ${q.question}<br>` +
          q.options.map((opt, idx) =>
            `<label><input type="radio" name="q${i}" value="${opt}"> ${String.fromCharCode(65 + idx)}. ${opt}</label><br>`
          ).join("");
        cont.appendChild(div);
      });

      cont.dataset.questions = JSON.stringify(questions);
      cont.style.display = "block";
      document.getElementById("submitBtn").style.display = "block";
    }

    document.getElementById("testSelect").addEventListener("change", e => {
      const id = e.target.value;
      if (id) loadQuestions(id);
    });

    async function submitQuiz() {
      const name = document.getElementById("name").value.trim();
      const userCode = document.getElementById("userCode").value.trim();
      const testId = document.getElementById("testSelect").value;
      const questions = JSON.parse(document.getElementById("quizContainer").dataset.questions || "[]");

      if (!name || !userCode || !testId) return alert("Please fill all fields.");
      if (!questions.length) return alert("No questions loaded.");

      const answers = questions.map((q, i) => {
        const selected = document.querySelector(`input[name="q${i}"]:checked`);
        return { question: q.question, selected: selected?.value || "" };
      });

      const res = await fetch(`${BASE}/test/${testId}/submit`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ name, userCode, answers })
      });

      const data = await res.json();
      if (res.ok) {
        alert("‚úÖ Quiz submitted successfully.");
        window.location.href = "index.html";
      } else {
        alert("‚ùå Submission failed: " + data.error);
      }
    }

    loadTests();
  </script>
</body>
</html>
