<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Take Quiz</title>
  <style>
    body { font-family: Arial; margin: 40px; }
    .question { margin-bottom: 20px; }
    button { padding: 10px 16px; font-size: 16px; margin-top: 20px; }
    select, input { padding: 8px; margin: 5px; font-size: 16px; }
  </style>
</head>
<body>

<h2>üöÄ Take a Quiz</h2>

<label>Name:</label>
<input type="text" id="name" placeholder="Your Name" />
<label>User Code:</label>
<input type="text" id="userCode" placeholder="Your Code" />

<br><br>
<label>Select Test:</label>
<select id="testSelect">
  <option value="">--Loading--</option>
</select>

<button onclick="loadTest()">üéØ Start Test</button>

<form id="quizForm" style="display:none;" onsubmit="submitQuiz(event)">
  <div id="questionContainer"></div>
  <button type="submit">‚úÖ Submit Quiz</button>
</form>

<script>
  const BASE = "https://quiz-app-4087.onrender.com/api/quiz";

  async function loadTestList() {
    const name = document.getElementById("name").value.trim();
    const userCode = document.getElementById("userCode").value.trim();

    if (!name || !userCode) return;

    try {
      const res = await fetch(`${BASE}/test-list-for-student?name=${name}&userCode=${userCode}`);
      const tests = await res.json();
      const select = document.getElementById("testSelect");
      select.innerHTML = '<option value="">--Select Test--</option>';
      tests.forEach(t => {
        const opt = document.createElement("option");
        opt.value = t;
        opt.textContent = t;
        select.appendChild(opt);
      });
    } catch (err) {
      console.error(err);
      alert("‚ùå Failed to load tests.");
    }
  }

  document.getElementById("name").addEventListener("blur", loadTestList);
  document.getElementById("userCode").addEventListener("blur", loadTestList);

  async function loadTest() {
    const testId = document.getElementById("testSelect").value;
    if (!testId) return alert("Please select a test.");

    try {
      const res = await fetch(`${BASE}/test/${testId}/questions`);
      const questions = await res.json();

      const container = document.getElementById("questionContainer");
      container.innerHTML = "";

      questions.forEach((q, i) => {
        const div = document.createElement("div");
        div.className = "question";
        div.innerHTML = `<p><strong>Q${i+1}:</strong> ${q.question}</p>`;
        q.options.forEach(opt => {
          div.innerHTML += `
            <label>
              <input type="radio" name="q${i}" value="${opt}" required />
              ${opt}
            </label><br>
          `;
        });
        container.appendChild(div);
      });

      document.getElementById("quizForm").style.display = "block";
    } catch (err) {
      alert("‚ùå Error loading quiz.");
    }
  }

  async function submitQuiz(event) {
    event.preventDefault();

    const name = document.getElementById("name").value.trim();
    const userCode = document.getElementById("userCode").value.trim();
    const testId = document.getElementById("testSelect").value;
    const answers = [];

    const radios = document.querySelectorAll("input[type='radio']:checked");

    radios.forEach((radio, i) => {
      const qText = document.querySelectorAll(".question p")[i].textContent.replace(/^Q\d+:\s*/, "");
      answers.push({ question: qText, selected: radio.value });
    });

    try {
      const res = await fetch(`${BASE}/test/${testId}/submit`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ name, userCode, answers })
      });

      const data = await res.json();
      if (res.ok) {
        alert("‚úÖ Quiz submitted!");
        window.location.href = "index.html";
      } else {
        alert("‚ùå Submission failed: " + data.error);
      }
    } catch (err) {
      alert("‚ùå Error submitting quiz.");
    }
  }
</script>

</body>
</html>
