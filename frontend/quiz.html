<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Take Quiz</title>
  <style>
    body { font-family: Arial; margin: 40px; }
    .questionBox { margin: 20px 0; padding: 20px; border: 1px solid #ccc; }
    .option { display: block; margin: 5px 0; }
    button { padding: 10px 20px; margin-top: 20px; }
  </style>
</head>
<body>

  <script>
    const BASE_URL = "https://quiz-app-4087.onrender.com";

    const role = sessionStorage.getItem("role");
    const studentName = sessionStorage.getItem("name");
    const userCode = sessionStorage.getItem("userCode");

    if (role !== "student" || !studentName || !userCode) {
      alert("Access denied. Please login as student.");
      window.location.href = "index.html";
    }
  </script>

  <h2>üß™ Welcome, <span id="studentName"></span></h2>

  <label for="testSelect">Select Test:</label>
  <select id="testSelect">
    <option value="">--Loading Tests--</option>
  </select>
  <button onclick="startQuiz()">‚ñ∂ Start Quiz</button>

  <form id="quizForm" style="display:none;" onsubmit="submitQuiz(event)">
    <div id="questionContainer"></div>
    <button type="submit">üöÄ Submit Quiz</button>
  </form>

  <script>
    document.getElementById("studentName").textContent = studentName;

    const testSelect = document.getElementById("testSelect");
    const questionContainer = document.getElementById("questionContainer");

    // Load tests mapped to this student
    window.onload = () => {
      fetch(`${BASE_URL}/api/quiz/testsForStudent?userCode=${userCode}`)
        .then(res => res.json())
        .then(tests => {
          testSelect.innerHTML = '<option value="">--Select Test--</option>';
          tests.forEach(t => {
            const opt = document.createElement("option");
            opt.value = t;
            opt.textContent = t;
            testSelect.appendChild(opt);
          });
        })
        .catch(err => {
          console.error(err);
          alert("‚ùå Failed to load test list.");
        });
    };

    function startQuiz() {
      const testId = testSelect.value;
      if (!testId) return alert("Please select a test.");

      fetch(`${BASE_URL}/api/quiz/test/${testId}/questions`)
        .then(res => res.json())
        .then(data => {
          questionContainer.innerHTML = "";
          data.forEach((q, idx) => {
            const div = document.createElement("div");
            div.className = "questionBox";

            div.innerHTML = `
              <h3>Q${idx + 1}: ${q.question}</h3>
              ${q.options.map((opt, i) =>
                `<label class="option">
                  <input type="radio" name="q${idx}" value="${opt}" required />
                  ${opt}
                </label>`).join("")}
            `;
            questionContainer.appendChild(div);
          });

          document.getElementById("quizForm").style.display = "block";
        })
        .catch(err => {
          console.error(err);
          alert("‚ùå Failed to load questions.");
        });
    }

    function submitQuiz(event) {
      event.preventDefault();

      const testId = testSelect.value;
      const answers = [];

      const qBoxes = document.querySelectorAll(".questionBox");
      qBoxes.forEach((box, idx) => {
        const qText = box.querySelector("h3").textContent.slice(4); // Remove Q1: etc.
        const selected = box.querySelector(`input[name="q${idx}"]:checked`);
        if (selected) {
          answers.push({ question: qText, selected: selected.value });
        }
      });

      fetch(`${BASE_URL}/api/quiz/test/${testId}/submit`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ testId, name: studentName, userCode, answers })
      })
        .then(res => res.json())
        .then(data => {
          if (data.message) {
            alert("‚úÖ Quiz submitted!");
            window.location.href = "index.html";
          } else {
            alert("‚ùå Submission failed.");
          }
        })
        .catch(err => {
          console.error(err);
          alert("‚ùå Server error while submitting.");
        });
    }
  </script>

</body>
</html>
