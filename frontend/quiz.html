<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Take Quiz</title>
  <style>
    body { font-family: Arial, margin: 40px; }
    .question { margin-bottom: 20px; padding: 10px; border: 1px solid #ccc; }
    label { display: block; margin-top: 5px; }
    button { padding: 10px 20px; font-size: 16px; margin-top: 20px; }
  </style>
</head>
<body>

  <script>
    const BASE_URL = "https://quiz-app-4087.onrender.com";

    const role = sessionStorage.getItem("role");
    const name = sessionStorage.getItem("name");
    const userCode = sessionStorage.getItem("userCode");

    if (role !== "student" || !name || !userCode) {
      alert("Access denied. Please login as student.");
      window.location.href = "index.html";
    }
  </script>

  <h2>üìù Take a Test</h2>
  <label for="testSelect">Select Test:</label>
  <select id="testSelect">
    <option value="">-- Loading Tests --</option>
  </select>

  <div id="quizContainer" style="display:none;">
    <form id="quizForm"></form>
    <button onclick="submitQuiz()">Submit Quiz</button>
  </div>

  <script>
    let selectedTest = "";

    window.onload = () => {
      fetch(`${BASE_URL}/api/quiz/test-list-for-student?name=${encodeURIComponent(name)}&userCode=${encodeURIComponent(userCode)}`)
        .then(res => res.json())
        .then(tests => {
          const select = document.getElementById("testSelect");
          select.innerHTML = '<option value="">-- Select Test --</option>';
          tests.forEach(t => {
            const opt = document.createElement("option");
            opt.value = t;
            opt.textContent = t;
            select.appendChild(opt);
          });

          select.addEventListener("change", () => {
            selectedTest = select.value;
            sessionStorage.setItem("selectedTest", selectedTest);
            loadQuiz(selectedTest);
          });
        })
        .catch(err => {
          console.error(err);
          alert("‚ùå Failed to load tests.");
        });
    };

    function loadQuiz(testId) {
      fetch(`${BASE_URL}/api/quiz/test/${testId}/questions`)
        .then(res => res.json())
        .then(data => {
          const form = document.getElementById("quizForm");
          form.innerHTML = "";
          data.forEach((q, index) => {
            const div = document.createElement("div");
            div.className = "question";

            div.innerHTML = `<strong>Q${index + 1}. ${q.question}</strong><br>
              ${q.options.map((opt, i) => `
                <label>
                  <input type="radio" name="q${index}" value="${opt}" />
                  ${String.fromCharCode(65 + i)}. ${opt}
                </label>`).join("")}`;

            form.appendChild(div);
          });

          document.getElementById("quizContainer").style.display = "block";
        });
    }

    function submitQuiz() {
      const testId = selectedTest;
      if (!testId) return alert("Please select a test first.");

      const form = document.getElementById("quizForm");
      const answers = [];

      const questions = form.querySelectorAll(".question");
      questions.forEach((div, i) => {
        const questionText = div.querySelector("strong").innerText.replace(/^Q\d+\. /, "");
        const selectedOption = div.querySelector("input[type='radio']:checked");
        if (selectedOption) {
          answers.push({ question: questionText, selected: selectedOption.value });
        }
      });

      fetch(`${BASE_URL}/api/quiz/test/${testId}/submit`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ testId, name, userCode, answers })
      })
        .then(res => res.json())
        .then(data => {
          if (data.message) {
            alert("‚úÖ Quiz submitted successfully!");
            window.location.href = "quiz.html";
          } else {
            alert("‚ùå " + (data.error || "Submission failed"));
          }
        })
        .catch(err => {
          console.error(err);
          alert("‚ùå Failed to submit quiz.");
        });
    }
  </script>

</body>
</html>
