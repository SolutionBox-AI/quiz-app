<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>View Responses</title>
  <style>
    body { font-family: Arial; padding: 30px; background: #f4f6f8; }
    h2 { margin-bottom: 20px; }
    select, button { padding: 8px 12px; font-size: 16px; margin-right: 10px; }
    table { width: 100%; border-collapse: collapse; margin-top: 20px; background: #fff; }
    th, td { border: 1px solid #ccc; padding: 8px; text-align: left; }
    th { background-color: #f0f0f0; }
  </style>
</head>
<body>
  <script>
    if (sessionStorage.getItem("role") !== "admin") {
      alert("Access denied. Please login as admin.");
      window.location.href = "index.html";
    }
  </script>

  <h2>üìã View & Download Quiz Responses</h2>

  <label>Select Test:</label>
  <select id="testSelect"><option>Loading tests...</option></select>
  <button onclick="viewResponses()">üëÅ View</button>
  <button onclick="downloadResponses()">üì• Download JSON</button>
  <button onclick="location.href='admin.html'">üè† Back to Admin</button>

  <div id="tableContainer"></div>

  <script>
    const BASE = "https://quiz-app-4087.onrender.com/api/quiz";

    window.onload = () => {
      fetch(`${BASE}/tests`)
        .then(r => r.json())
        .then(tests => {
          const sel = document.getElementById('testSelect');
          sel.innerHTML = '<option value="">-- Select Test --</option>';
          tests.forEach(t => sel.appendChild(new Option(t, t)));
        })
        .catch(err => alert("‚ùå Failed to load test list."));
    };

    let lastData = [];

    function viewResponses() {
      const testId = document.getElementById("testSelect").value;
      if (!testId) return alert("Please select a test.");

      fetch(`${BASE}/test/${testId}/responses`)
        .then(r => r.json())
        .then(data => {
          lastData = data;
          renderTable(data);
        })
        .catch(err => alert("‚ùå Failed to load responses."));
    }

    function renderTable(data) {
      if (!data.length) return document.getElementById("tableContainer").innerHTML = "<p>No responses available.</p>";

      const headers = `
        <tr>
          <th>#</th>
          <th>User Code</th>
          <th>Name</th>
          <th>Submitted</th>
          <th>Answers</th>
        </tr>
      `;
      const rows = data.map((r, i) => `
        <tr>
          <td>${i + 1}</td>
          <td>${r.userCode || '-'}</td>
          <td>${r.name}</td>
          <td>${new Date(r.submittedAt).toLocaleString()}</td>
          <td>${r.answers.map(a => `${a.question}: <strong>${a.selected || '‚Äì'}</strong>`).join("<br>")}</td>
        </tr>
      `).join("");

      document.getElementById("tableContainer").innerHTML = `
        <table>
          <thead>${headers}</thead>
          <tbody>${rows}</tbody>
        </table>
      `;
    }

    function downloadResponses() {
      if (!lastData.length) return alert("‚ùå No data to download.");
      const blob = new Blob([JSON.stringify(lastData, null, 2)], { type: "application/json" });
      const a = document.createElement("a");
      a.href = URL.createObjectURL(blob);
      a.download = `${document.getElementById("testSelect").value}-responses.json`;
      a.click();
    }
  </script>
</body>
</html>
