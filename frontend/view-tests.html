<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>View & Manage Test Questions</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      padding: 40px;
      background: #f9f9f9;
    }

    #logoutBtn {
      position: absolute;
      top: 20px;
      right: 20px;
      background: #d9534f;
      color: white;
      border: none;
      padding: 8px 16px;
      cursor: pointer;
      border-radius: 4px;
    }

    select, button {
      padding: 8px 12px;
      font-size: 16px;
      margin: 8px 5px 16px 0;
    }

    .question-block {
      background: #fff;
      border: 1px solid #ccc;
      margin-bottom: 16px;
      padding: 16px;
      border-radius: 8px;
      position: relative;
    }

    .question-block h4 {
      margin-bottom: 8px;
    }

    .option {
      margin-left: 16px;
    }

    .deleteBtn {
      position: absolute;
      top: 10px;
      right: 10px;
      background-color: #ff4d4d;
      color: white;
      border: none;
      border-radius: 4px;
      padding: 4px 8px;
      cursor: pointer;
    }

    .saveBtn {
      background: green;
      color: white;
      border: none;
      border-radius: 4px;
      padding: 10px 16px;
      font-size: 16px;
    }
  </style>
</head>
<body>

  <button id="logoutBtn" onclick="logout()">üö™ Logout</button>

  <h2>üß† Manage Test Questions</h2>

  <label for="testSelect">Select Test:</label>
  <select id="testSelect"><option value="">Loading...</option></select>
  <button onclick="loadQuestions()">üìÑ Load Questions</button>

  <div id="questionsDisplay"></div>

  <button class="saveBtn" onclick="saveUpdatedTest()">üíæ Save Updated Test</button>

  <script>
    const BASE_URL = "https://quiz-app-4087.onrender.com";
    let currentQuestions = [];

    function logout() {
      sessionStorage.clear();
      window.location.href = "index.html";
    }

    window.onload = () => {
      fetch(`${BASE_URL}/tests`)
        .then(res => res.json())
        .then(tests => {
          const sel = document.getElementById('testSelect');
          sel.innerHTML = '<option value="">-- Select Test --</option>';
          tests.forEach(t => {
            const opt = document.createElement('option');
            opt.value = t;
            opt.textContent = t;
            sel.appendChild(opt);
          });
        })
        .catch(err => {
          console.error(err);
          alert("‚ùå Failed to load test list.");
        });
    };

    function loadQuestions() {
      const testId = document.getElementById('testSelect').value;
      const display = document.getElementById('questionsDisplay');
      display.innerHTML = "";
      currentQuestions = [];

      if (!testId) return alert("Please select a test.");

      fetch(`${BASE_URL}/test/${testId}/questions`)
        .then(res => res.json())
        .then(questions => {
          if (!questions.length) {
            display.innerHTML = "<p>No questions found.</p>";
            return;
          }

          currentQuestions = questions; // Store for deletion
          renderQuestions();
        })
        .catch(err => {
          console.error(err);
          alert("‚ùå Failed to load questions.");
        });
    }

    function renderQuestions() {
      const display = document.getElementById('questionsDisplay');
      display.innerHTML = "";

      currentQuestions.forEach((q, index) => {
        const div = document.createElement("div");
        div.className = "question-block";
        div.innerHTML = `
          <button class="deleteBtn" onclick="deleteQuestion(${index})">‚ùå</button>
          <h4>Q${index + 1}: ${q.question}</h4>
          <p class="option">A. ${q.options[0]}</p>
          <p class="option">B. ${q.options[1]}</p>
          <p class="option">C. ${q.options[2]}</p>
          <p class="option">D. ${q.options[3]}</p>
          <p><strong>‚úÖ Correct Answer:</strong> ${q.correctAnswer}</p>
        `;
        display.appendChild(div);
      });
    }

    function deleteQuestion(index) {
      if (confirm("Are you sure you want to delete this question?")) {
        currentQuestions.splice(index, 1);
        renderQuestions();
      }
    }

    async function saveUpdatedTest() {
      const testId = document.getElementById('testSelect').value;
      if (!testId || currentQuestions.length === 0) {
        return alert("Please select test and ensure there are questions to save.");
      }

      try {
        const res = await fetch(`${BASE_URL}/test/${testId}/save`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(currentQuestions)
        });

        const result = await res.json();
        if (res.ok) {
          alert("‚úÖ Updated test saved successfully!");
        } else {
          alert("‚ùå Failed to save: " + result.error);
        }
      } catch (err) {
        console.error(err);
        alert("‚ö†Ô∏è Server error while saving.");
      }
    }
  </script>

</body>
</html>
